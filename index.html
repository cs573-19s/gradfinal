<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <script src="http://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3-scale-radial.js"></script>
    <title>Title</title>
</head>
<script type="text/javascript" src="script.js"></script>
<body>
<div id="fullpage">
    <div class = "leftside" id="sidebar"></div>
    <div class = "rightside" id="radialChart"></div>

</div>

<link rel="stylesheet" href="style.css">
<script type="text/javascript">

    var smallGap = 10;
    var largeGap = 30;
    var outerRadius = window.innerHeight * 2/5;
    var innerRadius = outerRadius * 4/5;

    var numBars = 100;

    var height = 975;
    var width = 975;

        var sidebar = d3.select("#sidebar")
            .append("svg")
            .attr("id", "#sidebarSvg")
            .attr("width", "100%")
            .attr("height", screen.height)
            .append("g");

        var totalY = 0;

        sidebar.append("rect")
            .attr("width", (screen.width/5))
            .attr("height", 150)
            .attr("fill","#C5AF8A");

        totalY += 160;

        sidebar.append("rect")  //select either the apple store or google play store
            .attr("width", (screen.width/5))
            .attr("height", 150)
            .attr("y", totalY)
            .attr("fill","#F0EFEC");
        sidebar.append("text")
                .attr("x",20)
                .attr("y", totalY + 20)
                .style("text-anchor", "left")
                .attr("font-size", "18px")
                .attr("fill", "#000")
                .text("Source");
        sidebar.append("text")
            .attr("id", "androidLabel")
                .attr("x",(screen.width/15))
                .attr("y", totalY + 80)
                .style("text-anchor", "middle")
                .attr("font-size", "18px")
                .attr("fill", "#AB8B53")
                .text("Google Play");
        sidebar.append("rect")  //google play store select
            .attr("opacity", 0.0)
            .attr("x",(screen.width/15) - 50)
            .attr("y", totalY + 50)
            .attr("width", 100)
            .attr("height", 60)
            .on("click",
                function (){
                    d3.selectAll("text").attr("fill", "#000");
                    d3.select("#androidLabel").attr("fill", "#AB8B53");
                    loadNewData("https://data.42matters.com/api/v2.0/android/apps/top_google_charts.json?list_name=topselling_free&cat_key=OVERALL&country=US&limit=100&access_token=6d0f4cc3c6a6b21c14e193a4325ed9736863d32f" , null, "Android")
                }
            );

        sidebar.append("text")
            .attr("id", "iosLabel")
                .attr("x",(screen.width*2/15))
                .attr("y", totalY + 80)
                .style("text-anchor", "middle")
                .attr("font-size", "18px")
                .attr("fill", "#000")
                .attr("pointer-events", "all")
                .text("Apple Store");
        sidebar.append("rect")  //apple app store select
            .attr("opacity", 0.0)
            .attr("x",(screen.width*2/15) - 50)
            .attr("y", totalY + 50)
            .attr("width", 100)
            .attr("height", 60)
            .on("click",
                function (){
                    d3.selectAll("text").attr("fill", "#000");
                    d3.select("#iosLabel").attr("fill", "#AB8B53");
                    loadNewData("https://data.42matters.com/api/v2.0/ios/apps/top_appstore_charts.json?list_name=topselling_free&limit=100&access_token=6d0f4cc3c6a6b21c14e193a4325ed9736863d32f", null, "iOS")
                }
            );




        function loadNewData(dataSource, categorySelection, os)
            {
                d3.json(dataSource).then(function(topCharts) {

                    var sortedList = [];
                    var categoryList = [];
                    var unsortedList = [[]];

                    topCharts.sorted_app_list = [];

                    console.log(topCharts);

                    if (os === "iOS") {

                        for (var i = 0; i < topCharts.app_list.length; i++) {
                            topCharts.app_list[i].category = topCharts.app_list[i].primaryGenreName;
                            topCharts.app_list[i].rating = topCharts.app_list[i].averageUserRating;
                            topCharts.app_list[i].title = topCharts.app_list[i].trackCensoredName;
                            topCharts.app_list[i].developer = topCharts.app_list[i].artistName;
                        }
                    }


                    for (i = 0; i < topCharts.app_list.length; i++) {

                        if (!categoryList.includes(topCharts.app_list[i].category)) {
                            categoryList.push(topCharts.app_list[i].category);
                            unsortedList[categoryList.length - 1] = [];
                            for (var j = 0; j < topCharts.app_list.length; j++) {
                                if (topCharts.app_list[j].category === topCharts.app_list[i].category) {
                                    unsortedList[unsortedList.length - 1].push(topCharts.app_list[j]);
                                }
                            }
                        }
                    }

                    var categoryListAngle = [];
                    for (i = 0; i < unsortedList.length; i++) {
                        sortedList.push(bubbleSort(unsortedList[i]));
                    }

                    var labelAngle = d3.scaleLinear()
                        .range([0, 2 * Math.PI])
                        .domain([0, topCharts.app_list.length]);

                    var lastCount = 0;
                    var counter = 0;
                    for (i = 0; i < sortedList.length; i++) {
                        for (j = 0; j < sortedList[i].length; j++) {
                            counter++;
                            sortedList[i][j].isGap = false; //create a gap between categories
                            topCharts.sorted_app_list.push(sortedList[i][j]);
                        }
                        topCharts.sorted_app_list[topCharts.sorted_app_list.length - 1].isGap = true; //make the last element in the list true
                        var thisObject = {};
                        thisObject.label = categoryList[i];
                        thisObject.angle = labelAngle((lastCount + counter) / 2);
                        lastCount = counter;
                        categoryListAngle.push(thisObject)
                    }


                    var extent = d3.extent(topCharts.sorted_app_list, function (d) {
                        return d.rating;
                    });

                    var x = d3.scaleBand()
                        .range([0, 2 * Math.PI])
                        .domain(topCharts.sorted_app_list.map(function (d) {
                            return d.title
                        }));

                    var y = d3.scaleRadial()
                        .range([innerRadius, outerRadius])
                        .domain([2, 5]);

                    var reverseY = d3.scaleRadial()
                        .range([2, 5])
                        .domain([innerRadius, outerRadius]);


                    var chordX = d3.scaleLinear()
                        .range([0, Math.PI])
                        .domain([0, 1]);

                    var arc = d3.arc()
                        .innerRadius(innerRadius)
                        .outerRadius(function (d) {
                            return y(d.rating)
                        })
                        .startAngle(function (d) {
                            return x(d.title)
                        })
                        .endAngle(function (d) {
                            if (d.isGap === false)
                                return x(d.title) + x.bandwidth();
                            else
                                return x(d.title) + x.bandwidth() - 0.01;
                        });

                    var hoverY = d3.scaleRadial()
                        .range([innerRadius, outerRadius + 200])
                        .domain([0, 5]);

                    var startY = d3.scaleRadial()
                        .range([innerRadius, innerRadius + 1])
                        .domain([0, 5]);


                    var hoverArc = d3.arc()
                        .innerRadius(innerRadius)
                        .outerRadius(function (d) {
                            return hoverY(d.rating)
                        })
                        .startAngle(function (d) {
                            return x(d.title)
                        })
                        .endAngle(function (d) {
                            return x(d.title) + x.bandwidth();
                        })
                        .padAngle(0.01)
                        .padRadius(innerRadius);

                    var startArc = d3.arc()
                        .innerRadius(innerRadius)
                        .outerRadius(function (d) {
                            return startY(d.rating)
                        })
                        .startAngle(function (d) {
                            return x(d.title)
                        })
                        .endAngle(function (d) {
                            return x(d.title) + x.bandwidth();
                        })
                        .padAngle(0.01)
                        .padRadius(innerRadius);

                    var currCategory = "";

                    var otherArc = d3.arc()
                        .innerRadius(innerRadius)
                        .outerRadius(function (d) {
                            return y(d.rating)
                        })
                        .startAngle(function (d) {
                            return x(d.title)
                        })
                        .endAngle(function (d) {
                            if (d.category === currCategory)
                                return x(d.title) + x.bandwidth() - 0.01;
                            else
                                return x(d.title) + x.bandwidth();
                        });

                    var containerWidth = document.getElementById("radialChart").offsetWidth;
                    var containerHeight = document.getElementById("radialChart").offsetHeight;

                    var svg = d3.select("#radialChart")
                        .call(function () {
                            var currSvg = document.getElementById("#chartSvg");
                            if (currSvg) //if the current svg exists, get rid of it
                                currSvg.remove();
                        })
                        .append("svg")
                        .attr("id", "#chartSvg")
                        .attr("width", "100%")
                        .attr("height", window.innerHeight)
                        .append("g")
                        .attr("transform", "translate(" + containerWidth / 2 + "," + window.innerHeight / 2 + ")");

                    console.log(topCharts);
                    var segments =
                        svg.selectAll("path")
                            .data(topCharts.sorted_app_list)
                            .enter().append("path")
                            .attr("class", "bar")
                            .style("fill", "#F2A69F")
                            .attr("opacity", 0.0)
                            .attr("d", startArc)
                            .on("click", function (d) {
                                var icon = svg.selectAll("image")
                                    .data([d], function (d) {
                                        return d;
                                    });
                                icon.interrupt();
                                update(d, svg);

                            })
                            .on("mouseover", function (d) {
                                tooltipAppData.style("display", null);

                                currCategory = d.category;
                                d3.selectAll(".bar")
                                    .transition()
                                    .duration(500)
                                    .ease(d3.easeExpOut)
                                    .attr("d", otherArc)
                                    .attr("opacity",
                                        function (d) {
                                            if (d.category === currCategory)
                                                return 1.0;

                                            else
                                                return 0.4;
                                        }
                                    );

                                d3.select(this)
                                    .transition()
                                    .duration(500)
                                    .ease(d3.easeExpOut)
                                    .attr("d", hoverArc)
                                    .attr("opacity", 1.0);

                            })
                            .on("mouseout", function (d) {

                                tooltipAppData.style("display", "none");
                                d3.select(this)
                                    .transition()
                                    .attr("d", arc);

                            })
                            .on("mousemove", function (d) {
                                var xPosition = d3.mouse(this)[0] - 25;
                                var yPosition = d3.mouse(this)[1] - 70;

                                tooltipAppData.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
                                tooltipAppData
                                    .select("#name")
                                    .text(d.title);
                                tooltipAppData
                                    .select("#developer")
                                    .text(
                                        d.developer);
                                tooltipAppData
                                    .select("#rating")
                                    .text(
                                        d.rating.toFixed(2) + "/5 stars");
                                tooltipAppData
                                    .select("#category")
                                    .text(d.category);

                            })

                            .transition()
                            .ease(d3.easeElasticOut)
                            .delay(function (d, i) {
                                return 10 * i
                            })
                            .duration(1000)
                            .attr("opacity", 1.0)
                            .attr("d", arc);


                    var labels = svg.selectAll("text")
                        .data(categoryListAngle)
                        .enter().append("text")
                        .attr("dy", ".35em")
                        .attr("transform", d => `
                    rotate(${(d.angle * 180 / Math.PI - 90)})
                    translate(${outerRadius + 10})
                    ${d.angle > Math.PI ? "rotate(180)" : ""}
                  `)
                        .attr("text-anchor", d => d.angle > Math.PI ? "end" : null)
                        .text(function (d) {
                                return d.label;
                            }
                        )
                        .attr("opacity", 0.0)
                        .transition()
                        .duration(300)
                        .delay(function (d, i) {
                            return 50 * i
                        })
                        .ease(d3.easeCubicOut)
                        .attr("class", "label")
                        .attr("opacity", 1.0);

                    var ratingLabel = svg.append("text")
                        .attr("id", "ratingLabel")
                        .attr("y", -outerRadius - 50)
                        .style("text-anchor", "middle")
                        .attr("font-size", "40px")
                        .text("5.0/5 stars");

                    var ratingCircle = svg
                        .append("circle")
                        .attr("class", "circle")
                        .classed("outer", true)
                        .attr("r", 100)
                        .style("fill", "none")
                        .transition()
                        .delay(500)
                        .duration(2000)
                        .ease(d3.easeElasticOut)
                        .attr("r", outerRadius)
                        .style("fill", "none")
                        .style("stroke", "#A27C40")
                        .style("stroke-width", "2");

                    var isRatingClicked = false;

                    var currRadius = outerRadius;
                    var ratingRhombus = svg
                        .append("rect")
                        .attr("width", 30)
                        .attr("height", 30)
                        .attr('transform', 'translate(0,' + (-100 - 30 * Math.pow(2, 0.5) / 2) + ')' +
                            'rotate(45)'
                        )
                        .call(d3.drag()
                            .on("start", function () {
                                d3.select(this).raise().classed("active", true);
                            })
                            .on("drag", function () {
                                var yPosition = Math.abs(d3.event.y);

                                if (yPosition <= outerRadius +2 && yPosition >= innerRadius - 2) {
                                    d3.select(this)
                                        .attr('transform', 'translate(0,' + (-(yPosition) - 30 * Math.pow(2, 0.5) / 2 + 1) + ')' +
                                            'rotate(45)'
                                        );
                                    d3.selectAll(".circle").attr("r", yPosition);
                                    d3.select("#ratingLabel")
                                        .text(function () {
                                            return reverseY(yPosition).toFixed(2) + "/5 stars";
                                        })
                                        .style("fill", "#FB8F27")
                                        .attr("y", -yPosition - 50)
                                        .transition()
                                        .duration(9000)
                                        .ease(d3.easeExpOut)
                                        .style("fill", "#000000");


                                    d3.selectAll(".bar")
                                        .transition()
                                        .duration(500)
                                        .ease(d3.easeExpOut)
                                        .style("fill", function (d) {
                                            if (d.rating > reverseY(yPosition)) {
                                                return "#EAE3D6";
                                            } else {
                                                return "#F2A69F";
                                            }

                                        });
                                }
                            })
                            .on("end", function () {
                                    d3.select(this).classed("active", false);
                                }
                            )
                        )
                        .attr("opacity", "0.0")

                        .transition()
                        .delay(500)
                        .duration(2000)
                        .ease(d3.easeElasticOut)
                        .style("fill", "#A27C40")
                        .attr("opacity", "1.0")
                        .attr('transform', 'translate(0,' + (-outerRadius - 30 * Math.pow(2, 0.5) / 2 + 1) + ')' +
                            'rotate(45)'
                        );


                    var tooltipAppData = svg.append("g")
                        .attr("class", "tooltip")
                        .style("display", "none");

                    tooltipAppData.append("rect")
                        .attr("width", 215)
                        .attr("height", 75)
                        .attr("fill", "white")
                        .attr("pointer-events", "none")
                        .attr("stroke-width", "1px")
                        .style("opacity", 0.7);

                    tooltipAppData.append("text")
                        .attr("id", "name")
                        .attr("x", 5)
                        .attr("dy", "1.2em")
                        .style("text-anchor", "left")
                        .attr("pointer-events", "none")
                        .attr("font-size", "16px")
                        .attr("font-weight", "bold");


                    tooltipAppData.append("text")
                        .attr("id", "developer")
                        .attr("x", 5)
                        .attr("dy", "2.5em")
                        .style("text-anchor", "left")
                        .attr("pointer-events", "none")
                        .attr("font-size", "14px");


                    tooltipAppData.append("text")
                        .attr("id", "rating")
                        .attr("x", 5)
                        .attr("dy", "3.6em")
                        .style("text-anchor", "left")
                        .attr("pointer-events", "none")
                        .attr("font-size", "14px");


                    tooltipAppData.append("text")
                        .attr("id", "category")
                        .attr("x", 5)
                        .attr("dy", "4.7em")
                        .style("text-anchor", "left")
                        .attr("pointer-events", "none")
                        .attr("font-size", "14px");


                });

            }
            loadNewData("https://data.42matters.com/api/v2.0/android/apps/top_google_charts.json?list_name=topselling_free&cat_key=OVERALL&country=US&limit=100&access_token=6d0f4cc3c6a6b21c14e193a4325ed9736863d32f", null);

            function bubbleSort(arr){
                var len = arr.length;
                for (var q = len - 1; q >= 0; q--){
                    for(var w = 1; w <= q; w++){
                        if(arr[w-1].rating > arr[w].rating){
                            var temp = arr[w-1];
                            arr[w-1] = arr[w];
                            arr[w] = temp;
                        }
                    }
                }
                return arr;
            }

            function mapNextValues(data)
            {
                var copy = JSON.parse(JSON.stringify(data)); //copy the data so we don't permanently change it

                copy[0].prevAnglePos = 0;
                var positive = 0;
                var negative = 0;
                var totalPercentage = 0;
                for(var p = 0; p < copy.length; p++) {
                    totalPercentage += copy[p].reviews_percentage;
                    copy[p].prevAnglePos = positive;
                    positive += copy[p].positive * copy[p].reviews_percentage;
                    copy[p].prevAngleNeg = negative;
                    negative += copy[p].negative * copy[p].reviews_percentage;

                }
                for(p = 0; p < copy.length; p++)
                {
                    copy[p].prevAngleNeg += positive;
                    copy[p].totalPercentage = totalPercentage;
                    copy[p].numCategories = copy.length;
                }

                copy.unshift(copy[0]);  //TODO: d3 data is skipping the first element for some reason
                return copy;
            }



            function update(data, svg) {

                var t = d3.transition()
                    .duration(500)
                    .ease(d3.easeExpOut);
                // JOIN new data with old elements.
                var icon = svg.selectAll("image")
                    .data([data], function(d) { return d;});

                var mappedData = mapNextValues(data.review_analysis.topics);


                var chordDiagram = svg.selectAll("path")
                    .data(mappedData, function(d){return d;});

                var chordCircles = svg.selectAll("circle")
                    .data(mappedData, function(d){return d;});

                var chordLabels = svg.selectAll("text")
                    .data(mappedData, function(d){return d;});

                var innerOuterRadius = innerRadius * 3/5;
                var innerInnerRadius = innerOuterRadius * 9/10;

                var positiveChordArc = d3.arc()
                    .innerRadius(innerInnerRadius)
                    .outerRadius(innerOuterRadius)
                    .startAngle(function (d) {
                        var chordX = d3.scaleLinear()
                            .range([Math.PI/2, Math.PI * 3 / 2])
                            .domain([0, d.totalPercentage]);

                        var originalPoint = chordX(d.prevAnglePos + d.positive * d.reviews_percentage);
                        return originalPoint - 2*(originalPoint - Math.PI); //return the inversion
                    })
                    .endAngle(function (d) {
                        var chordX = d3.scaleLinear()
                            .range([Math.PI/2, Math.PI * 3 / 2])
                            .domain([0, d.totalPercentage]);

                        var originalPoint = chordX(d.prevAnglePos);
                        return originalPoint - 2*(originalPoint - Math.PI); //return the inversion
                    });


                var negativeChordArc = d3.arc()
                    .innerRadius(innerInnerRadius)
                    .outerRadius(innerOuterRadius)
                    .startAngle(function (d) {
                        var chordX = d3.scaleLinear()
                            .range([Math.PI/2, Math.PI * 3 / 2])
                            .domain([0, d.totalPercentage]);
                        var originalPoint = chordX(d.prevAngleNeg + d.negative * d.reviews_percentage);
                        return originalPoint - 2*(originalPoint - Math.PI); //return the inversion

                    })
                    .endAngle(function (d) {
                        var chordX = d3.scaleLinear()
                            .range([Math.PI/2, Math.PI * 3 / 2])
                            .domain([0, d.totalPercentage]);
                        var originalPoint = chordX(d.prevAngleNeg);
                        return originalPoint - 2*(originalPoint - Math.PI); //return the inversion
                    });

                var positiveRibbon = d3.ribbon()
                    .radius(innerInnerRadius)
                    .source(function (d) {
                        d.beginningOrEnd = "beginning";
                        return JSON.parse(JSON.stringify(d));
                    })
                    .target(function (d) {
                        d.beginningOrEnd = "end";
                        return JSON.parse(JSON.stringify(d));
                    })
                    .startAngle(function(d, i) {
                        console.log(i);
                        if (d.beginningOrEnd === "beginning") {
                            var originAngle = d3.scaleLinear()
                                .range([0, Math.PI])
                                .domain([0,  d.numCategories]);
                            return originAngle(i - 0.55) - Math.PI / 2;
                        } else if (d.beginningOrEnd === "end") {
                                originAngle = d3.scaleLinear()
                                .range([Math.PI/2, Math.PI * 3 / 2])
                                .domain([0, d.totalPercentage]);
                            var originalPoint = originAngle(d.prevAnglePos + d.positive * d.reviews_percentage);
                            return originalPoint - 2*(originalPoint - Math.PI); //return the inversion
                        }
                    })
                    .endAngle(function(d, i) {
                        if (d.beginningOrEnd === "beginning") {
                            var originAngle = d3.scaleLinear()
                                .range([0, Math.PI])
                                .domain([0, d.numCategories]);
                            return originAngle(i-0.5) - Math.PI / 2;
                        } else if (d.beginningOrEnd === "end") {
                                originAngle = d3.scaleLinear()
                                .range([Math.PI/2, Math.PI * 3 / 2])
                                .domain([0, d.totalPercentage]);
                            var originalPoint = originAngle(d.prevAnglePos);
                            return originalPoint - 2*(originalPoint - Math.PI); //return the inversion

                        }
                    });

                var negativeRibbon = d3.ribbon()
                    .radius(innerInnerRadius)
                    .source(function (d) {
                        d.beginningOrEnd = "beginning";
                        return JSON.parse(JSON.stringify(d));
                    })
                    .target(function (d) {
                        d.beginningOrEnd = "end";
                        return JSON.parse(JSON.stringify(d));
                    })
                    .startAngle(function(d, i) {
                        if (d.beginningOrEnd === "beginning") {
                            var originChord1 = d3.scaleLinear()
                                .range([0, Math.PI])
                                .domain([0,  d.numCategories]);
                            return originChord1(i - 0.5) - Math.PI / 2;
                        } else if (d.beginningOrEnd === "end") {
                            var originChord2 = d3.scaleLinear()
                                .range([Math.PI/2, Math.PI * 3 / 2])
                                .domain([0, d.totalPercentage]);
                            var originalPoint = originChord2(d.prevAngleNeg + d.negative * d.reviews_percentage);
                            return originalPoint - 2*(originalPoint - Math.PI); //return the inversion
                        }
                    })
                    .endAngle(function(d, i) {
                        if (d.beginningOrEnd === "beginning") {
                            var originChord3 = d3.scaleLinear()
                                .range([0, Math.PI])
                                .domain([0, d.numCategories]);
                            return originChord3(i - 0.45) - Math.PI / 2;
                        } else if (d.beginningOrEnd === "end") {
                            var originChord4 = d3.scaleLinear()
                                .range([Math.PI/2, Math.PI * 3 / 2])
                                .domain([0, d.totalPercentage]);
                            var originalPoint = originChord4(d.prevAngleNeg);
                            return originalPoint - 2*(originalPoint - Math.PI); //return the inversion
                        }
                    });

                d3.selection.prototype.moveToFront = function () {
                    return this.each(function () {
                        this.parentNode.appendChild(this);
                    });
                };
                d3.selection.prototype.moveToBack = function () {
                    return this.each(function () {
                        var firstChild = this.parentNode.firstChild;
                        if (firstChild) {
                            this.parentNode.insertBefore(this, firstChild);
                        }
                    });
                };


                svg.selectAll(".chord").remove();
                svg.selectAll(".ribbon").remove();
                svg.selectAll(".chordCircle").remove();
                svg.selectAll(".chordLabel").remove();
                svg.selectAll(".sentimentLabel").remove();



                chordDiagram.enter().append("path")
                    .style("opacity", 1e-6)
                    .attr("class", "chord")
                    .style("fill", "#FB8F27")
                    .attr("d", positiveChordArc)
                    .transition(t)
                    .style("opacity", 1.0)
                    .attr("class", "chord")
                    .style("fill", "#FB8F27")
                    .attr("d", positiveChordArc);

                chordDiagram.enter().append("path")
                    .style("opacity", 1e-6)
                    .attr("class", "chord")
                    .style("fill", "#9378D6")
                    .attr("d", negativeChordArc)
                    .transition(t)
                    .style("opacity", 1.0)
                    .attr("class", "chord")
                    .style("fill", "#9378D6")
                    .attr("d", negativeChordArc);

                chordDiagram.enter().append("path")
                    .style("opacity", 1e-6)
                    .attr("class", "ribbon")
                    .style("fill", "#FB8F27")
                    .attr("d", positiveRibbon)
                    .attr("stroke", "#000")
                    .transition(t)
                    .style("opacity", 0.6)
                    .attr("class", "ribbon")
                    .style("fill", "#FB8F27")
                    .attr("d", positiveRibbon)
                    .attr("stroke", "#000");

                chordDiagram.enter().append("path")
                    .style("opacity", 1e-6)
                    .attr("class", "ribbon")
                    .style("fill", "#9378D6")
                    .attr("d", negativeRibbon)
                    .attr("stroke", "#000")
                    .transition(t)
                    .style("opacity", 0.6)
                    .attr("class", "ribbon")
                    .style("fill", "#9378D6")
                    .attr("d", negativeRibbon)
                    .attr("stroke", "#000");

                chordCircles.enter().append("text")
                    .attr("class", "chordLabel")
                    .text(function(d, i){
                        if(i !== 0) //skip the first result because of our previous bandaid fix
                            return d.topic_name;
                        else
                            return "";

                    })
                    .attr("transform", function(d, i) {
                        var circleAngle = d3.scaleLinear()
                            .range([0, Math.PI])
                            .domain([0,  d.numCategories]);
                        if(i !== 0) //skip the first result because of our previous bandaid fix
                            return `
                        rotate(${((circleAngle(i - 0.5) - Math.PI / 2) * 180 / Math.PI - 90)})
                        translate(${innerOuterRadius*11/10})
                        ${(circleAngle(i - 0.5) - Math.PI / 2) < 0 ? "rotate(180)" : ""}
                     `;})
                    .attr("text-anchor", function(d, i) {
                        var circleAngle = d3.scaleLinear()
                            .range([0, Math.PI])
                            .domain([0,  d.numCategories]);
                        return (circleAngle(i - 0.5) - Math.PI / 2) < 0 ? "end" : null;})
                    .style("fill", function(d){
                        if(d.positive > d.negative)
                        {
                            return "#FB8F27";
                        }else{
                            return "#9378D6";
                        }
                    });

                chordCircles.enter().append("circle")
                    .attr("class", "chordCircle")
                    .attr("r", function(d, i)
                    {
                        if(i !== 0) //skip the first result because of our previous bandaid fix
                            return 15;
                        else
                            return 0;
                    })
                    .attr("transform", function(d, i) {
                        var circleAngle = d3.scaleLinear()
                            .range([0, Math.PI])
                            .domain([0,  d.numCategories]);
                        return `
                        rotate(${((circleAngle(i - 0.5) - Math.PI / 2) * 180 / Math.PI - 90)})
                        translate(${innerInnerRadius})
                     `;})
                    .style("fill", function(d){
                        if(d.positive > d.negative)
                        {
                            return "#F7B77B";
                        }else{
                            return "#B8ADD3";
                        }
                    })
                    .style("opacity", 1.0)
                    .attr("stroke-width", 2)
                    .attr("stroke", "#000")
                    .on("mouseover", function(d){
                        svg.selectAll(".sentimentLabel")
                            .remove();

                        var thisCategory = d.topic_name;
                        d3.select(this)
                            .transition()
                            .duration(500)
                            .ease(d3.easeExpOut)
                            .attr("r", 30);
                        d3.selectAll(".chord")
                            .transition()
                            .duration(500)
                            .ease(d3.easeExpOut)

                            .style("opacity", function(d) {
                                if(d.topic_name !== thisCategory){
                                    return 0.5;
                                }else{
                                    return 1.0;
                                }
                            });
                        d3.selectAll(".ribbon")
                            .transition()
                            .duration(500)
                            .ease(d3.easeExpOut)

                            .style("opacity", function(d) {
                                if(d.topic_name !== thisCategory){
                                    return 0.3;
                                }else{
                                    return 0.7;
                                }
                            });


                        svg.append("text")
                            .attr("class", "sentimentLabel")
                            .style("text-anchor", "middle")
                            .attr("font-size", "18px")
                            .attr("fill", "#000")
                            .attr("y", innerOuterRadius * 1.1)
                            .text("Topic: " + thisCategory);

                        svg.append("text")
                            .attr("class", "sentimentLabel")
                            .style("text-anchor", "middle")
                            .attr("font-size", "18px")
                            .attr("fill", "#FB8F27")
                            .attr("y", innerOuterRadius * 1.1)
                            .attr("dy", "1.2em")
                            .text("Percent Positive Sentiment: " + (d.positive * d.reviews_percentage* 100).toFixed(1) + "%");

                        svg.append("text")
                            .attr("class", "sentimentLabel")
                            .style("text-anchor", "middle")
                            .attr("font-size", "18px")
                            .attr("fill", "#9378D6")
                            .attr("dy", "2.4em")
                            .attr("y", innerOuterRadius * 1.1)
                            .text("Percent Negative Sentiment: " + (d.negative * d.reviews_percentage * 100).toFixed(1) + "%");


                    })
                    .on("mouseout", function(d){
                        d3.select(this)
                            .transition()
                            .duration(500)
                            .ease(d3.easeExpOut)
                            .attr("r", 15);
                    });


                icon.attr("class", "update")
                    .style("opacity", 1e-6)
                    .attr('x', -50)
                    .attr('y', -50)
                    .attr('width', 100)
                    .attr('height', 100)
                    .moveToFront()
                    .attr('xlink:href',
                        function(d) {
                            return d.icon;
                        }
                    )
                    .transition(t)
                    .style("opacity", 1);


                icon.style("opacity", 1e-6)
                    .attr('x', -50)
                    .attr('y', -50)
                    .attr('width', 100)
                    .attr('height', 100)
                    .attr('xlink:href',
                        function(d) {
                            return d.icon;
                        }
                    )
                    .transition(t)
                    .style("opacity", 1);

                icon.enter().append("image")
                    .style("opacity", 1e-6)
                    .attr('x', -50)
                    .attr('y', -50)
                    .attr('width', 100)
                    .attr('height', 100)
                    .attr('xlink:href',
                        function(d) {
                            return d.icon;
                        }
                    )
                    .transition(t)
                    .style("opacity", 1);



                icon.exit().remove();

            }


</script>
</body>
</html>