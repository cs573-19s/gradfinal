<script src="https://d3js.org/d3.v5.min.js"></script>

<style>
    .chart {
        display: block;
        margin: auto;
    }

    rect {
        stroke: black;
        stroke-width: 2px;
        fill: steelblue;
    }

    circle {
        stroke: black;
        stroke-width: 2px;
    }

    .chart text {
        fill: white;
        text-anchor: end;
    }

    .axis path, .axis line {
        fill: none;
        stroke: #000000;
        shape-rendering: crispEdges;
    }

    #nextButton {
        background-color: #FF0000;
        border: none;
        color: white;
        padding: 16px 32px;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        cursor: pointer;
        display: inline-block;
    }

    #nameText {
        display: inline-block;
        height: 32px;
        width: 100px;
    }

    #percentText {
        display: inline-block;
        height: 32px;
        width: 100px;
    }

    #group {
        margin-top: 25px;
        text-align: center;
    }

    table {
        margin: auto;
        margin-top: 25px;
    }

    #title {
        display: none;
        text-align: center;
    }
</style>

<body>
<svg class="chart" width=550 height=550></svg>
<h1 id="title"></h1>

<div id="group">
    <input type="text" value="" placeholder="Enter name" id="nameText"/>
    <input type="text" value="" placeholder="Enter percent" id="percentText" autofocus/>

    <button id="nextButton" onClick="updateGraph()">Next Graph</button>

</div>

<div id="table"></div>

</body>

<script>
    console.log(d3);

    document.getElementById("percentText")
        .addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                document.getElementById("nextButton").click();
            }
        });

    var data = Array(10);

    var name = "";

    var count = 1;

    var actuals = [];

    var reported = [];

    var types = [];

    var marked = [0, 0];

    var currentType = "";

    var width = 450, height = 500, margin = 10;

    var marked1, marked2 = 0;

    var counts = [0, 0, 0, 0];

    function randomCircleNumber() {
        return Math.floor((Math.random() * 70) + 30);

    }

    function randomSquareNumber() {
        return Math.floor((Math.random() * 120) + 50);
    }

    function randomBarNumber() {
        return Math.floor((Math.random() * 37) + 3);
    }

    function storeBarResults() {

        name = document.getElementById("nameText").value;

        reported.push(document.getElementById("percentText").value);

        types.push(currentType);

        actuals.push(Math.abs(Math.round((Math.min(data[0], data[1])) / (Math.max(data[0], data[1])) * 100)));

    }

    function storeCircleResults() {

        name = document.getElementById('nameText').value;

        reported.push(document.getElementById('percentText').value);

        types.push(currentType);

        actuals.push(Math.abs(Math.round((3.14 * Math.pow(Math.min(data[0], data[1]), 2)) / (3.14 * Math.pow(Math
            .max(data[0], data[1]), 2)) * 100)));
    }

    function storeSquareResults() {

        name = document.getElementById('nameText').value;

        reported.push(document.getElementById('percentText').value);

        types.push(currentType);

        actuals.push(Math.abs(Math.round((Math.pow(Math.min(data[0], data[1]), 2)) / (Math.pow(Math
            .max(data[0], data[1]), 2)) * 100)));
    }

    function pickMarks() {

        marked1 = Math.floor(Math.random() * 5);
        marked2 = Math.floor(Math.random() * 5);

        while (marked1 === marked2) {
            marked2 = Math.floor(Math.random() * 5);
        }

    }

    function displayResults() {

        d3.select(".chart").attr("width", 0).attr("height", 0);
        document.getElementById("title").style.display = "block";
        document.getElementById("title").innerHTML = "Below are the results for user: " + name;
        document.getElementById("nextButton").style.display = "none";
        document.getElementById("nameText").style.display = "none";
        document.getElementById("percentText").style.display = "none";

        var html = "<table border = '1'1>";

        html += "<tr>";
        html += "<th>Name</th>";
        html += "<th>Trial Number</th>";
        html += "<th>Vis Type</th>";
        html += "<th>Actual Percent</th>";
        html += "<th>Reported Percent</th>";

        for (i = 0; i < reported.length; i++) {
            html += "<tr>";
            html += "<td>" + name + "</td>";
            html += "<td>" + (i + 1) + "</td>";
            html += "<td>" + types[i] + "</td>";
            html += "<td>" + actuals[i] + "</td>";
            html += "<td>" + reported[i] + "</td>";
        }

        html += "</table>";

        document.getElementById("table").innerHTML = html;

    }

    function makeGraph() {

        var type = Math.floor(Math.random() * 4);
        if (type === 0 && counts[0] < 20) {
            makeCircles();
        } else if (type === 1 && counts[1] < 20) {
            makeSquares();
        } else if (type === 2 && counts[2] < 20) {
            marked = pickMarks();
            makeBars();
        } else if (type === 3 && counts[3] < 20) {
            marked = pickMarks();
            makeSideBars();
        } else {
            makeGraph();
        }
    }

    function updateGraph() {

        if (document.getElementById("nameText").value == "" || document.getElementById("percentText").value == "") {
            alert("You must enter both a name and a percentage!");
            return;
        }

        if (currentType === 'Bar' || currentType === 'SideBar') {
            storeBarResults();
        } else if (currentType === 'Circle') {
            storeCircleResults();
        } else if (currentType === 'Square') {
            storeSquareResults();
        }

        document.getElementById("percentText").value = "";

        d3.select(".chart").html("");

        if (count < 80) {
            pickMarks();
            makeGraph();
            count++;
        } else {
            displayResults();
        }

        document.getElementById("percentText").focus();

    }

    function makeCircles() {

        currentType = 'Circle';

        data = Array(2).fill(0).map(randomCircleNumber);

        var svg = d3.select('svg');

        var scale = d3.scaleLinear().domain([0, d3.max(data)]).range([0, d3.max(data)]);

        var x1 = margin + 100;
        var x2 = width - margin - 100;

        svg.append('circle')
            .attr('cx', x1)
            .attr('cy', height / 2)
            .attr('r', scale(data[0]))
            .attr('fill', 'steelblue');

        svg.append('circle')
            .attr('cx', x2)
            .attr('cy', height / 2)
            .attr('r', scale(data[1]))
            .attr('fill', 'steelblue');

        counts[0] += 1;
    }

    function makeSquares() {

        currentType = 'Square';

        data = Array(2).fill(0).map(randomSquareNumber);

        var svg = d3.select('svg');

        var scale = d3.scaleLinear().domain([0, d3.max(data)]).range([0, d3.max(data)]);

        var x1 = 60;
        var x2 = 270;

        svg.append('rect')
            .attr('x', x1)
            .attr('y', 165)
            .attr('width', scale(data[0]))
            .attr('height', scale(data[0]));

        svg.append('rect')
            .attr('x', x2)
            .attr('y', 165)
            .attr('width', scale(data[1]))
            .attr('height', scale(data[1]));

        counts[1] += 1;

    }

    function makeBars() {

        marked = pickMarks();

        currentType = 'Bar';

        data = Array(5).fill(0).map(randomBarNumber);

        var svg = d3.select('svg');

        var scale = d3.scaleLinear().domain([0, d3.max(data)]).range([0, height - margin * 3]);

        var barWidth = (width - margin) / data.length;

        var xAxis = svg.append('line').attr('y1', height - margin).attr('y2', height - margin).attr('x1', 0).attr('x2', barWidth * 3).attr('stroke-width', 3).attr('stroke', 'black');

        var yAxis = svg.append('line').attr('y1', 0).attr('y2', height - margin).attr('x1', 0).attr('x2', 0).attr('stroke-width', 3).attr('stroke', 'black');

        var currentX = margin + 5;

        for (i = 0; i < 2; i++) {
            svg.append('rect')
                .attr('x', currentX)
                .attr('y', height - scale(data[i]) - margin)
                .attr('width', barWidth)
                .attr('height', scale(data[i]));

            /*
            if(i === marked1 || i === marked2){
                svg.append('circle')
                    .attr('cx', currentX + barWidth / 2)
                    .attr('cy', height + 15)
                    .attr('r', 5)
                    .attr('fill', 'black');
            }
            */

            currentX += barWidth + 5;
        }

        counts[2] += 1;
    }

    function makeSideBars() {

        marked = pickMarks();

        currentType = 'SideBar';

        data = Array(5).fill(0).map(randomBarNumber);

        var svg = d3.select('svg');

        var scale = d3.scaleLinear().domain([0, d3.max(data)]).range([0, height - margin * 3]);

        var barWidth = (width - margin) / data.length;

        var xAxis = svg.append("line").attr("y1", 0).attr("y2", 0).attr("x1", margin + 25).attr("x2", height + 100).attr("stroke-width", 3).attr("stroke", "black");

        var yAxis = svg.append("line").attr("y1", 0).attr("y2", barWidth * 3).attr("x1", margin + 25).attr("x2", margin + 25).attr("stroke-width", 3).attr("stroke", "black");

        var currentY = margin + 5;

        for (i = 0; i < 2; i++) {
            svg.append('rect')
                .attr('x', margin + 25)
                .attr('y', currentY)
                .attr('width', scale(data[i]))
                .attr('height', barWidth)
                .attr('fill', 'steelblue');

            /*
            if(i === marked1 || i === marked2){
                svg.append('circle')
                    .attr('cx', margin + 5)
                    .attr('cy', currentY + barWidth/2 + margin)
                    .attr('r', 5)
                    .attr('fill', 'black');
            }
            */
            currentY += barWidth + 5;
        }


        counts[3] += 1;
    }

    makeGraph();

</script>