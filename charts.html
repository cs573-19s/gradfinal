<script src="https://d3js.org/d3.v5.min.js"></script>

<style>
    .chart {
        display: block;
        margin: auto;
    }

    .rects {
        stroke: black;
        stroke-width: 2px;
        fill: steelblue;
    }

    circle {
        stroke: black;
        stroke-width: 2px;
    }

    .chart text {
        fill: white;
        text-anchor: end;
    }

    .axis path, .axis line {
        fill: none;
        stroke: #000000;
        shape-rendering: crispEdges;
    }

    #nextButton {
        background-color: #FF0000;
        border: none;
        color: white;
        padding: 16px 32px;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        cursor: pointer;
    }

    #givenText {
        text-align: center;
        font-size: 50px;
        font-weight: bold;
    }

    #nameText {
        display: inline-block;
        height: 32px;
        width: 100px;
    }

    #valueText {
        display: inline-block;
        height: 32px;
        width: 100px;
    }

    #group {
        margin-top: 25px;
        text-align: center;
    }

    table {
        margin: 25px auto auto;
    }

    #title {
        display: none;
        text-align: center;
    }
</style>

<body>
<svg class="chart" width=500 height=400></svg>
<h1 id="title"></h1>

<div id="group">
    <p id = "givenText">Test</p>
    <input type="text" value="" placeholder="Enter name" id="nameText"/>
    <input type="text" value="" placeholder="Enter value" id="valueText" autofocus/>

    <button id="nextButton" onClick="updateGraph()">Next Graph</button>

</div>

<div id="table"></div>

</body>

<script>
    console.log(d3);

    document.getElementById("valueText")
        .addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                document.getElementById("nextButton").click();
            }
        });

    let format1 = d3.format("3");

    let format2 = d3.format("00.2f");

    let data = Array(10);

    let name = "";

    let count = 1;

    let givens = [];

    let actuals = [];

    let reported = [];

    let types = [];

    let currentType = "";

    let counts = [0, 0, 0, 0]; // brightness, length, area, velocity

    function randomBrightnessNumber() {
        return Math.floor(Math.random() * 96 + 5) / 100 ;
    }

    function randomLengthNumber() {
        return Math.floor((Math.random() * 150) + 50);
    }

    function randomAreaNumber() {
        return Math.floor((Math.random() * 100) + 10);
    }


    //define a range for the random velocity number****************
    function randomVelocityNumber() {
        return Math.floor((Math.random() * 500) + 500);
    }

    function storeBrightnessResults() {

        name = document.getElementById("nameText").value;

        reported.push(document.getElementById("valueText").value);

        types.push(currentType);

        givens.push(data[0] * 100);

        actuals.push(data[1] * 100);

    }

    function storeLengthResults() {

        name = document.getElementById('nameText').value;

        reported.push(document.getElementById('valueText').value);

        types.push(currentType);

        actuals.push(Math.abs(Math.round((3.14 * Math.pow(Math.min(data[0], data[1]), 2)) / (3.14 * Math.pow(Math
            .max(data[0], data[1]), 2)) * 100)));
    }

    function storeAreaResults() {

        name = document.getElementById('nameText').value;

        reported.push(document.getElementById('valueText').value);

        types.push(currentType);

        givens.push(Math.pow(data[0], 2) / 100);

        actuals.push(Math.pow(data[1], 2) / 100);
    }

    function storeVelocityResults() {

        name = document.getElementById('nameText').value;

        reported.push(document.getElementById('valueText').value);

        types.push(currentType);

        // givens

        // actuals

    }

    function displayResults() {

        d3.select(".chart").attr("width", 0).attr("height", 0);
        document.getElementById("title").style.display = "block";
        document.getElementById("title").innerHTML = "Below are the results for user: " + name;
        document.getElementById("nextButton").style.display = "none";
        document.getElementById("nameText").style.display = "none";
        document.getElementById("valueText").style.display = "none";

        let html = "<table border = '1'>";

        html += "<tr>";
        html += "<th>Name</th>";
        html += "<th>Trial Number</th>";
        html += "<th>Test Type</th>";
        html += "<th>Given Value</th>";
        html += "<th>Actual Value</th>";
        html += "<th>Reported Value</th>";

        for (let i = 0; i < reported.length; i++) {
            html += "<tr>";
            html += "<td>" + name + "</td>";
            html += "<td>" + (i + 1) + "</td>";
            html += "<td>" + types[i] + "</td>";
            html += "<td>" + givens[i] + "</td>";
            html += "<td>" + actuals[i] + "</td>";
            html += "<td>" + reported[i] + "</td>";
        }

        html += "</table>";

        document.getElementById("table").innerHTML = html;

    }

    function chooseTest() {

        let type = Math.floor(Math.random() * 4);
        if (type === 0 && counts[0] < 10) {
            brightnessTest();
        } else if (type === 1 && counts[1] < 10) {
            lengthTest();
        } else if (type === 2 && counts[2] < 10) {
            areaTest();
        } else if (type === 3 && counts[3] < 10) {
            velocityTest();
        } else {
            chooseTest();
        }
    }

    function updateGraph() {

        if (document.getElementById("nameText").value === "" || document.getElementById("valueText").value === "") {
            alert("You must enter both a name and a percentage!");
            return;
        }

        if (currentType === 'Brightness') {
            storeBrightnessResults();
        } else if (currentType === 'Length') {
            storeLengthResults();
        } else if (currentType === 'Area') {
            storeAreaResults();
        } else if (currentType === "Velocity") {
            storeVelocityResults();
        }

        document.getElementById("valueText").value = "";

        d3.select(".chart").html("");

        if (count < 40) {
            chooseTest();
            count++;
        } else {
            displayResults();
        }

        document.getElementById("valueText").focus();

    }

    function brightnessTest() {

        d3.select('body').style('background-color', 'black');
        d3.select('#givenText').style('color', 'white');

        currentType = 'Brightness';

        let sideLength = 120;

        data = Array(2).fill(0).map(randomBrightnessNumber);

        let svg = d3.select('svg');

        let x1 = 60;
        let x2 = 270;

        svg.append('rect')
            .attr('x', x1)
            .attr('y', 165)
            .attr('width', sideLength)
            .attr('height', sideLength)
            .attr('fill', 'white')
            .attr('opacity', data[0]);

        svg.append('rect')
            .attr('x', x2)
            .attr('y', 165)
            .attr('width', sideLength)
            .attr('height', sideLength)
            .attr('fill', 'white')
            .attr('opacity', data[1]);

        document.getElementById("givenText").innerHTML = "Given value: " + format1(data[0] * 100);

        counts[0] += 1;
    }

    function lengthTest() {

        d3.select('body').style('background-color', 'white');
        d3.select('#givenText').style('color', 'black');

        currentType = 'Length';

        data = Array(2).fill(0).map(randomLengthNumber);

        let svg = d3.select('svg');

        let x1 = 250, x2 = 300, y1 = 200;

        svg.append('line')
            .attr('x1', x1)
            .attr('x2', x1)
            .attr('y1', y1)
            .attr('y2', y1 + data[0])
            .attr('stroke', 'black')
            .attr('stroke-width', '4');

        svg.append('line')
            .attr('x1', x2)
            .attr('x2', x2)
            .attr('y1', y1)
            .attr('y2', y1 + data[1])
            .attr('stroke', 'black')
            .attr('stroke-width', '4');

        document.getElementById("givenText").innerHTML = "Given value: " + data[0];

        counts[1] += 1;
    }

    function areaTest() {

        d3.select('body').style('background-color', 'white');
        d3.select('#givenText').style('color', 'black');

        currentType = 'Area';

        data = Array(2).fill(0).map(randomAreaNumber);

        let svg = d3.select('svg');

        let x1 = 60;
        let x2 = 270;

        svg.append('rect')
            .attr('x', x1)
            .attr('y', 165)
            .attr('width', data[0])
            .attr('height', data[0])
            .attr('class', 'rects');

        svg.append('rect')
            .attr('x', x2)
            .attr('y', 165)
            .attr('width', data[1])
            .attr('height', data[1])
            .attr('class', 'rects');

        document.getElementById("givenText").innerHTML = "Given value: " + format2(Math.pow(data[0], 2) / 100);

        counts[2] += 1;

    }

    function velocityTest() {

        d3.select('body').style('background-color', 'white');
        d3.select('#givenText').style('color', 'black');

        currentType = 'Velocity';

        // change velocity number calculation as needed, but DO NOT use any type of scale
        data = Array(2).fill(0).map(randomVelocityNumber);


        let svg = d3.select('svg');

        /*
        Enter velocity vis here using data and svg
         */
         function circleTransition() {

            var fastCircle = svg.append("circle")
                .attr("fill", "steelblue")
                .attr("r", 20);
            var slowCircle = svg.append("circle")
                .attr("fill", "steelblue")
                .attr("r", 20)
            
            var fastX = 200;
            var slowX = 300;

            var chosenLeft = Math.round(Math.random());

            if(chosenLeft == 1){
                fastX = 300
                slowX = 200
            }

            repeat();

            function repeat() {

                fastCircle
                    .attr('cx', fastX)
                    .attr('cy', 50)
                    .transition()
                    .duration(d3.min(data))
                    .attr('cy', 350);
                slowCircle
                    .attr('cx', slowX)
                    .attr('cy', 50)
                    .transition()
                    .duration(d3.max(data))
                    .attr('cy', 350)
                    .on("end", repeat);  // when both transitions finish, they start again together
            };

            document.getElementById("givenText").innerHTML = "Given value: " + format1(1500 - data[chosenLeft]);

            console.log(data);
            console.log(chosenLeft);
        };

        circleTransition();



        counts[3] += 1;
    }

    //chooseTest();
    velocityTest();

</script>